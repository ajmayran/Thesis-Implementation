<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Work Licensure Exam Predictor - Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    
    <style>
        .kpi-card {
            border-radius: 10px;
        }

        .glass {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
            border-radius: 12px;
        }

        .metric {
            font-weight: 700;
        }

        .muted {
            color: #6b7280;
        }

        .sidebar {
            background: linear-gradient(180deg, #1f2937, #111827);
        }

        .nav-item {
            transition: background 0.2s;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-item.active {
            background: #232b47;
        }

        .feature-bar {
            height: 12px;
            border-radius: 8px;
        }

        .feature-fill {
            height: 100%;
            background: linear-gradient(90deg, #0ea5e9, #3b82f6);
            border-radius: 8px;
            transition: width 0.5s ease;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success-message {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stat-trend {
            font-size: 0.75rem;
            margin-top: 8px;
        }

        .stat-trend.up {
            color: #10b981;
        }

        .stat-trend.down {
            color: #ef4444;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans text-gray-800">
    
    <div class="flex min-h-screen">
        
        <aside class="sidebar w-64 text-white p-6 hidden md:block">
            <div class="flex items-center mb-8">
                <div class="mr-3 bg-white/10 p-2 rounded-lg">
                    <i class="fa-solid fa-user-graduate text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold">Social Work<br />Predictor</h1>
                </div>
            </div>

            <nav class="space-y-2">
                <a href="{% url 'dashboard:home' %}" class="flex items-center p-3 nav-item rounded text-sm active">
                    <i class="fa-solid fa-house-chimney mr-3 w-5"></i>Dashboard
                </a>
                <a href="{% url 'prediction:predict' %}" class="flex items-center p-3 nav-item rounded text-sm">
                    <i class="fa-solid fa-brain mr-3 w-5"></i>Predictions
                </a>
                <a href="#" class="flex items-center p-3 nav-item rounded text-sm">
                    <i class="fa-solid fa-chart-line mr-3 w-5"></i>Reports
                </a>
                <a href="#" class="flex items-center p-3 nav-item rounded text-sm">
                    <i class="fa-solid fa-file-export mr-3 w-5"></i>Export
                </a>
                <a href="{% url 'accounts:logout' %}" class="flex items-center p-3 nav-item rounded text-sm text-red-300 hover:bg-red-900/20">
                    <i class="fa-solid fa-right-from-bracket mr-3 w-5"></i>Logout
                </a>
            </nav>

            <div class="mt-10 text-xs text-gray-300">
                <div>© 2024 Thesis Project</div>
                <div class="mt-1">Version 1.0.0</div>
            </div>
        </aside>

        <div class="flex-1">
            
            <header class="bg-white p-4 md:pl-8 md:pr-8 flex items-center justify-between shadow-sm">
                <div class="text-xl font-semibold">Social Work Licensure Exam Predictor</div>
                <div class="flex items-center space-x-4">
                    <button id="refreshBtn" class="hidden md:inline-flex items-center bg-blue-600 hover:bg-blue-700 p-3 rounded text-sm text-white transition" title="Refresh Data">
                        <i class="fa-solid fa-arrows-rotate mr-2"></i>Refresh
                    </button>
                    <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center">
                        <i class="fa-solid fa-user text-white"></i>
                    </div>
                </div>
            </header>

            <main class="p-6 md:p-8">
                
                <div id="messageContainer"></div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    
                    <div class="kpi-card glass p-6 bg-gradient-to-br from-green-500 to-green-600 text-white">
                        <div class="text-sm font-semibold uppercase tracking-wide">Total Predictions Made</div>
                        <div class="text-4xl font-bold mt-4" id="totalPredictions">
                            <span class="loading"></span>
                        </div>
                        <div class="stat-trend up" id="totalPredictionsTrend"></div>
                    </div>

                    <div class="kpi-card glass p-6 bg-gradient-to-br from-blue-600 to-blue-700 text-white">
                        <div class="text-sm font-semibold uppercase tracking-wide">Average Likelihood of Passing</div>
                        <div class="text-4xl font-bold mt-4" id="avgLikelihood">
                            <span class="loading"></span>
                        </div>
                        <div class="stat-trend" id="avgLikelihoodTrend"></div>
                    </div>

                    <div class="kpi-card glass p-6 bg-gradient-to-br from-red-600 to-red-700 text-white">
                        <div class="text-sm font-semibold uppercase tracking-wide">At-Risk Students</div>
                        <div class="text-4xl font-bold mt-4" id="atRiskStudents">
                            <span class="loading"></span>
                        </div>
                        <div class="stat-trend down" id="atRiskTrend"></div>
                    </div>

                    <div class="kpi-card glass p-6 bg-gradient-to-br from-emerald-600 to-emerald-700 text-white">
                        <div class="text-sm font-semibold uppercase tracking-wide">Likely to Pass</div>
                        <div class="text-4xl font-bold mt-4" id="likelyToPass">
                            <span class="loading"></span>
                        </div>
                        <div class="stat-trend up" id="likelyToPassTrend"></div>
                    </div>

                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <div class="lg:col-span-2 space-y-6">

                        <div class="glass p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-lg font-semibold uppercase tracking-wide">Model Performance Metrics</h2>
                                <div class="text-sm text-gray-500" id="lastUpdated">Loading...</div>
                            </div>

                            <div class="grid grid-cols-5 gap-4 text-center">
                                <div>
                                    <div class="text-3xl font-bold text-gray-800" id="modelAccuracy">--</div>
                                    <div class="muted text-sm mt-1">Accuracy</div>
                                </div>
                                <div>
                                    <div class="text-3xl font-bold text-gray-800" id="modelPrecision">--</div>
                                    <div class="muted text-sm mt-1">Precision</div>
                                </div>
                                <div>
                                    <div class="text-3xl font-bold text-gray-800" id="modelRecall">--</div>
                                    <div class="muted text-sm mt-1">Recall</div>
                                </div>
                                <div>
                                    <div class="text-3xl font-bold text-gray-800" id="modelF1Score">--</div>
                                    <div class="muted text-sm mt-1">F1-Score</div>
                                </div>
                                <div>
                                    <div class="text-3xl font-bold text-gray-800" id="modelAUC">--</div>
                                    <div class="muted text-sm mt-1">AUC</div>
                                </div>
                            </div>
                        </div>

                        <div class="glass p-6">
                            <h3 class="text-lg font-semibold mb-4 uppercase tracking-wide">Prediction Trends (Last 12 Months)</h3>
                            <div class="chart-container">
                                <canvas id="trendChart"></canvas>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button id="downloadCsvBtn" class="flex-1 bg-white border-2 border-gray-300 hover:border-gray-400 py-3 rounded-lg text-gray-700 font-semibold transition flex items-center justify-center">
                                <i class="fa-solid fa-file-csv mr-2"></i>Download CSV
                            </button>
                            <button id="generatePdfBtn" class="flex-1 bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-lg font-semibold transition flex items-center justify-center">
                                <i class="fa-solid fa-file-pdf mr-2"></i>Generate PDF Report
                            </button>
                        </div>

                    </div>

                    <div class="space-y-6">

                        <div class="glass p-6">
                            <h3 class="text-lg font-semibold mb-4 uppercase tracking-wide">Feature Importance</h3>
                            <div id="featureImportanceContainer">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Loading feature importance...</p>
                                </div>
                            </div>
                        </div>

                        <div class="glass p-6">
                            <h3 class="text-lg font-semibold mb-4 uppercase tracking-wide">User Input Statistics</h3>
                            <div class="space-y-3" id="userStatsContainer">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Average GPA</span>
                                    <span class="font-semibold text-gray-800" id="avgGPA">--</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Most Common Study Hours</span>
                                    <span class="font-semibold text-gray-800" id="commonStudyHours">--</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Average Sleeping Hours</span>
                                    <span class="font-semibold text-gray-800" id="avgSleepHours">--</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Review Center Attendance</span>
                                    <span class="font-semibold text-gray-800" id="reviewCenterRate">--</span>
                                </div>
                            </div>
                        </div>

                        <div class="glass p-6">
                            <h3 class="text-lg font-semibold mb-4 uppercase tracking-wide">Model Status</h3>
                            <div class="space-y-3" id="modelStatusContainer">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Active Model</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold" id="activeModel">Random Forest</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Model Status</span>
                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold">READY</span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">Last Trained</span>
                                    <span class="font-semibold text-gray-800" id="lastTrained">--</span>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

            </main>

        </div>
    </div>

    <script>
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
        }

        const API_URLS = {
            dashboardStats: '/dashboard/api/dashboard/stats/',
            exportCSV: '/dashboard/api/dashboard/export-csv/',
            exportPDF: '/dashboard/api/dashboard/export-pdf/'
        };

        let trendChart = null;
        let dashboardData = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('refreshBtn')?.addEventListener('click', loadDashboardData);
            document.getElementById('downloadCsvBtn')?.addEventListener('click', downloadCSV);
            document.getElementById('generatePdfBtn')?.addEventListener('click', generatePDF);
        }

        async function loadDashboardData() {
            try {
                showLoading();
                
                const response = await fetch(API_URLS.dashboardStats);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                dashboardData = data;
                
                updateKPICards(data);
                updateModelMetrics(data);
                updateFeatureImportance(data);
                updateUserStatistics(data);
                initOrUpdateTrendChart(data);
                updateLastUpdated();
                
                showMessage('Dashboard data loaded successfully', 'success');
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showMessage('Failed to load dashboard data. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        function updateKPICards(data) {
            const kpi = data.kpi_metrics || {};
            
            document.getElementById('totalPredictions').textContent = 
                (kpi.total_predictions || 0).toLocaleString();
            
            document.getElementById('avgLikelihood').innerHTML = 
                `${(kpi.average_likelihood || 0).toFixed(1)}<span class="text-xl">%</span>`;
            
            document.getElementById('atRiskStudents').textContent = 
                (kpi.at_risk_students || 0).toLocaleString();
            
            document.getElementById('likelyToPass').textContent = 
                (kpi.likely_to_pass || 0).toLocaleString();
            
            if (kpi.trends) {
                document.getElementById('totalPredictionsTrend').textContent = 
                    `↑ ${kpi.trends.predictions || 0}% from last month`;
                document.getElementById('avgLikelihoodTrend').textContent = 
                    `${kpi.trends.likelihood >= 0 ? '↑' : '↓'} ${Math.abs(kpi.trends.likelihood || 0)}% from last month`;
                document.getElementById('atRiskTrend').textContent = 
                    `↓ ${kpi.trends.at_risk || 0}% from last month`;
                document.getElementById('likelyToPassTrend').textContent = 
                    `↑ ${kpi.trends.likely_pass || 0}% from last month`;
            }
        }

        function updateModelMetrics(data) {
            const perf = data.model_performance || {};
            
            document.getElementById('modelAccuracy').textContent = 
                perf.accuracy ? `${perf.accuracy}%` : '--';
            document.getElementById('modelPrecision').textContent = 
                perf.precision ? perf.precision.toFixed(2) : '--';
            document.getElementById('modelRecall').textContent = 
                perf.recall ? perf.recall.toFixed(2) : '--';
            document.getElementById('modelF1Score').textContent = 
                perf.f1_score ? perf.f1_score.toFixed(2) : '--';
            document.getElementById('modelAUC').textContent = 
                perf.auc ? perf.auc.toFixed(2) : '--';
        }

        function updateFeatureImportance(data) {
            const container = document.getElementById('featureImportanceContainer');
            const features = data.feature_importance || {};
            
            if (Object.keys(features).length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">No feature importance data available</p>';
                return;
            }
            
            const sortedFeatures = Object.entries(features)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 6);
            
            let html = '<div class="space-y-4">';
            
            sortedFeatures.forEach(([feature, importance]) => {
                const percentage = (importance * 100).toFixed(1);
                html += `
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <div class="text-sm font-medium text-gray-700">${formatFeatureName(feature)}</div>
                            <div class="text-sm text-gray-600">${percentage}%</div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 feature-bar">
                            <div class="feature-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function updateUserStatistics(data) {
            const stats = data.user_statistics || {};
            
            document.getElementById('avgGPA').textContent = 
                stats.average_gpa ? stats.average_gpa.toFixed(2) : '--';
            document.getElementById('commonStudyHours').textContent = 
                stats.common_study_hours || '--';
            document.getElementById('avgSleepHours').textContent = 
                stats.average_sleep_hours ? stats.average_sleep_hours.toFixed(1) : '--';
            document.getElementById('reviewCenterRate').textContent = 
                stats.review_center_rate ? `${stats.review_center_rate}%` : '--';
        }

        function initOrUpdateTrendChart(data) {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;

            const trendData = data.trend_data || {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                values: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            };

            if (trendChart) {
                trendChart.data.labels = trendData.labels;
                trendChart.data.datasets[0].data = trendData.values;
                trendChart.update();
            } else {
                trendChart = new Chart(ctx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: trendData.labels,
                        datasets: [{
                            label: 'Pass Likelihood (%)',
                            data: trendData.values,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: { size: 14 },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        return 'Likelihood: ' + context.parsed.y.toFixed(1) + '%';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 11 } }
                            },
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    stepSize: 20,
                                    callback: value => value + '%',
                                    font: { size: 11 }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateLastUpdated() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastUpdated').textContent = `Updated: Today, ${timeStr}`;
            
            const latestModelPerformance = dashboardData?.model_performance;
            if (latestModelPerformance) {
                document.getElementById('lastTrained').textContent = 'Recently';
            }
        }

        async function downloadCSV() {
            try {
                const response = await fetch(API_URLS.exportCSV);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `predictions_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showMessage('CSV file downloaded successfully', 'success');
            } catch (error) {
                console.error('Error downloading CSV:', error);
                showMessage('Failed to download CSV file', 'error');
            }
        }

        async function generatePDF() {
            try {
                showMessage('Generating PDF report...', 'info');
                const response = await fetch(API_URLS.exportPDF);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dashboard_report_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showMessage('PDF report generated successfully', 'success');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('Failed to generate PDF report', 'error');
            }
        }

        function formatFeatureName(name) {
            return name.replace(/_/g, ' ')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        function showLoading() {
        }

        function hideLoading() {
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageClass = type === 'error' ? 'error-message' : 
                               type === 'success' ? 'success-message' : 'success-message';
            
            const messageEl = document.createElement('div');
            messageEl.className = messageClass;
            messageEl.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg">&times;</button>
                </div>
            `;
            
            container.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        setInterval(loadDashboardData, 60000);
    </script>

</body>
</html>